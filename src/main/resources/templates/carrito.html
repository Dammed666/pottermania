<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{layout :: head}"></head>
<body>
    <header th:replace="~{layout :: header}"></header>

    <main>
        <div class="saludo">
            <img src="/imagenes/elcarro.png" alt=" El Carrito" class="titulo">
        </div>
        <!--<h1 class="cart-title">Tu Carrito</h1>-->
        
        <div th:if="${articulosEnCarrito.isEmpty()}" class="empty-cart-message">
            <p>El carrito está vacío.</p>
            <p>¡Explora nuestra <a th:href="@{/tienda}" class="tienda-title">TIENDA</a> para encontrar algo que te guste!</p>
        </div>
        
        <div class="cart-main-container">
            
            <div class="product-table-wrapper">
                <div class="cart-headers">
                    <span class="header-product">Producto</span>
                    <span class="header-quantity">Cantidad</span>
                    <span class="header-price">Precio</span>
                    <span class="header-actions"></span>
                </div>
                
                <div th:each="entry : ${articulosEnCarrito}" class="cart-item-row" th:data-item-id="${entry.key.id}">
                    <span class="item-name" th:text="${entry.key.nombre}"></span>

                    <!--nuevo codigo para añadir signos +/- a la cantidad de articulos-->
                    <span class="item-quantity-container">
                        <button class="quantity-btn decrease-btn" th:data-id="${entry.key.id}">-</button>
                        <span class="item-quantity" th:text="${entry.value}"></span>
                        <button class="quantity-btn increase-btn" th:data-id="${entry.key.id}">+</button>  
                    </span>
                        
                    <span class="item-price" th:text="${#numbers.formatDecimal(entry.key.precio, 1, 2, 'POINT')} + ' €'"></span>
                    <a th:href="@{/carrito/eliminar/{id}(id=${entry.key.id})}" class="item-remove">Eliminar</a>
                </div>
            </div>

            <div class="checkout-section">
                
                <div class="buyer-info-box">
                    <h3 class="buyer-info-title">Datos del Comprador</h3>
                    <form th:action="@{/carrito/finalizar-compra}" method="post" class="buyer-form">
                        <div class="form-group">
                            <label for="nombre">Nombre</label>
                            <input type="text" id="nombre" name="nombre" placeholder="Nombre completo" required list="clientes-list">
                            <datalist id="clientes-list">
                                <option th:each="cliente : ${clientes}" 
                                        th:value="${cliente.nombre}" 
                                        th:data-email="${cliente.email}"></option>
                            </datalist>
                        </div>
                        
                        <div class="form-group">
                            <label for="email">Email:</label>
                            <input type="email" class="form-control" id="email" name="email" 
                                    placeholder="ejemplo@email.com" required>
                        </div>

                        <div class="form-group form-check-flex">
                            <label for="contrareembolso">Compra contra reembolso</label>
                            <input type="checkbox" id="contrareembolso" name="contrareembolso" required>
                        </div>

                        <button type="submit" class="finalizar-btn">Finalizar Compra</button>
                    </form>
                </div>

                <div class="order-summary-box">
                    <h3 class="order-summary-title">Resumen del Pedido</h3>
                    <div class="summary-line">
                        <span>Subtotal:</span>
                        <span th:text="${#numbers.formatDecimal(subtotal, 1, 2, 'POINT')} + ' €'">0.00 €</span>
                    </div>
                    <div class="summary-line">
                        <span>IVA (21%):</span>
                        <span th:text="${#numbers.formatDecimal(iva, 1, 2, 'POINT')} + ' €'">0.00 €</span>
                    </div>
                    <div class="summary-line total-line">
                        <span>Total:</span>
                        <span th:text="${#numbers.formatDecimal(total, 1, 2, 'POINT')} + ' €'">0.00 €</span>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const nombreInput = document.getElementById("nombre");
            const emailInput = document.getElementById("email");
            const datalist = document.getElementById("clientes-list");

            // Lógica de autocompletado del email
            nombreInput.addEventListener("input", function() {
                const selectedOption = datalist.querySelector(`option[value='${nombreInput.value}']`);
                
                if (selectedOption) {
                    const email = selectedOption.getAttribute("data-email");
                    emailInput.value = email;
                } else {
                    emailInput.value = "";
                }
            });

            // lógica para los botones de cantidad
            const quantityButtons = document.querySelectorAll(".quantity-btn");
            
            const totalElements = {
                // Utilizamos selectores más directos y fiables para evitar el error
                subtotal: document.querySelector(".order-summary-box .summary-line:nth-of-type(1) span:last-child"),
                iva: document.querySelector(".order-summary-box .summary-line:nth-of-type(2) span:last-child"),
                total: document.querySelector(".order-summary-box .total-line span:last-child")
            };

            quantityButtons.forEach(button => {
                button.addEventListener("click", function() {
                    const itemRow = this.closest('.cart-item-row');
                    const itemId = this.getAttribute("data-id");
                    const action = this.classList.contains("increase-btn") ? "add" : "remove";

                    if (itemId){
                        updateCart(itemId, action);
                    }
                });
            });

            function updateCart(itemId, action) {
                fetch(`/carrito/actualizar-cantidad/${itemId}?action=${action}`)
                .then(response => response.json())
                .then(data => {
                    // Actualiza la cantidad en la tabla
                    const itemRow = document.querySelector(`.cart-item-row[data-item-id='${itemId}']`);
                    if (itemRow) {
                        const quantitySpan = itemRow.querySelector('.item-quantity');
                        quantitySpan.textContent = data.nuevaCantidad;
                    }

                    // Actualizar los totales
                    totalElements.subtotal.textContent = `${data.subtotal.toFixed(2)} €`;
                    totalElements.iva.textContent = `${data.iva.toFixed(2)} €`;
                    totalElements.total.textContent = `${data.total.toFixed(2)} €`;
                })
                .catch(error => console.error('Error al actualizar el carrito:', error));
            }
        });
    </script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const checkbox = document.getElementById("contrareembolso");
            const finalizarBtn = document.querySelector(".finalizar-btn"); // Seleccionamos por la clase 'finalizar-btn'

            // Deshabilita el botón al cargar la página si el checkbox no está marcado.
            finalizarBtn.disabled = !checkbox.checked;

            // Agrega un listener para detectar cambios en el estado del checkbox
            checkbox.addEventListener("change", function() {
                if (checkbox.checked) {
                    finalizarBtn.disabled = false; // Habilita el botón si el checkbox está marcado
                } else {
                    finalizarBtn.disabled = true;  // Deshabilita el botón si se desmarca
                }
            });
        });
    </script>

    <footer th:replace="~{layout :: footer}"></footer>
</body>
</html>